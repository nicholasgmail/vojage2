<template>  <div>    <search-bar      @update_map="handleMap"    ></search-bar>    <section class="wrapper_container">      <div id="homepage-map" class="mapboxgl-map"></div>    </section>  </div></template><script>import SearchBar from "../components/SearchBar.vue";import mapboxgl from "mapbox-gl";import 'mapbox-gl/dist/mapbox-gl.css';import {mapActions, mapGetters} from "vuex";import MoreFiltersContent from "../components/MoreFiltersContent.vue";mapboxgl.accessToken = 'pk.eyJ1Ijoidm95YWdldm95YWdlMSIsImEiOiJjbG5vY2pnbjgwaDNoMmtvZGhld2dtamxlIn0.I1ZefmSbGwtDxyexzf-8-A';export default {  name: "TermsPage",  components: {MoreFiltersContent, SearchBar},  layout: "Map",  data() {    return {      close: false,      base_url: process.env.BASE_URL,      geojson: {        'type': 'FeatureCollection',        'features': []      }    }  },  computed: {    ...mapGetters(['hotel', "tour", 'query']),  },  watch: {    hotel(newValue, oldValue) {      this.getGson(this.hotel);      setTimeout(this.genMap, 100);      return newValue;    }  },  async fetch() {    await this.$store.dispatch('setHotelList');  },  mounted() {    if (this.$route.name === 'map') {      document.body.classList.add('perso', 'babyLogin', 'map-open');    }    this.getGson(this.hotel);    setTimeout(this.genMap, 100);    //let clogo = document.querySelector(".mapboxgl-ctrl-logo");  },  methods: {    ...mapActions(["setHotelOut", 'setHotelTour', "setHotelList"]),    handleMap(data) {      this.getGson(this.hotel);    },    getGson(gothels) {      let filteredObj = [];      for (const key in gothels) {        filteredObj[key] = {          'type': 'Feature',          'properties': {            'id': `${gothels[key]["id"]}`,            'name': `${gothels[key]["name"]}`,            'show_price_or_sale': `${gothels[key]["show_price_or_sale"]}`,            'two_person_price': `${gothels[key]["two_person_price"]}`,            'sale_up_to': `${gothels[key]["sale_up_to"]}`,            'small_description': `${gothels[key]["small_description"]}`,            'sale_description': `${gothels[key]["sale_description"]}`,            'random_days': `${gothels[key]["random_days"]}`,            'iconSize': [40, 40]          },          'geometry': {            'type': 'Point',            'coordinates': [gothels[key]["longitude"], gothels[key]["latitude"]]          }        };      }      this.geojson["features"] = filteredObj;    },    genMap() {      const map = new mapboxgl.Map({        container: 'homepage-map',        style: 'mapbox://styles/mapbox/outdoors-v11',        center: [0, 0],        zoom: 2      });      const image = new Image();      image.src = '/images/f_map.svg';      map.on('load', () => {        map.addImage('custom-marker', image);        map.addSource('my-geojson', {          type: 'geojson',          data: this.geojson,          cluster: true,          clusterMaxZoom: 14,          clusterRadius: 50,        })        map.addLayer({          id: 'clusters',          type: 'circle',          source: 'my-geojson',          filter: ['has', 'point_count'],          paint: {            'circle-color': [              'step',              ['get', 'point_count'],              '#fff',              100,              '#f28cb1',              750,              '#f1f075',            ],            'circle-radius': ['step', ['get', 'point_count'], 20, 100, 30, 750, 40],          },        })        map.addLayer({          id: 'cluster-count',          type: 'symbol',          source: 'my-geojson',          filter: ['has', 'point_count'],          layout: {            'text-field': '{point_count_abbreviated}',            'text-font': ['DIN Offc Pro Medium', 'Arial Unicode MS Bold'],            'text-size': 12,          },        })        map.addLayer({          id: 'unclustered-point',          type: 'symbol',          source: 'my-geojson',          filter: ['!', ['has', 'point_count']],          layout: {            'icon-image': 'custom-marker',            'icon-size': 0.5,          },        })        map.on('click', 'unclustered-point', async (e) => {          const coordinates = e.features[0].geometry.coordinates;          const properties = e.features[0].properties;          const id = properties["id"];          await this.$store.dispatch('setHotelDetail', id);          const sale = this.$store.state.sale;          const durations = sale.durations.join(", ");          const without_flight = sale.min_price_price_without_flight.price;          const with_flight = sale.min_price_price_with_flight.price;          const sale_up_to = sale.sale_up_to;          const with_flight_duration = sale.min_price_price_with_flight.duration;          const without_flight_duration = sale.min_price_price_without_flight.duration;          let up_to = '';          if (properties.show_price_or_sale === 'price') {            up_to = `<span class="label price ribbon-txt-1 ">От</span><span class="price  ribbon-txt-3">                  ${properties.two_person_price}₴ </span></span>`          } else if (properties.show_price_or_sale === 'sale') {            up_to = `<span class="label price ribbon-txt-1 ">Скидка</span><span class="price  ribbon-txt-3">                  -${properties.sale_up_to}%</span></span>`          }          new mapboxgl.Popup()            .setLngLat(coordinates)            .setHTML(`<div class="container-tooltip"><div class="map-tooltip clearfix specific-not-near"><div class="map-title">${sale["name"]}</div><div class="map-subtitle">${properties["small_description"]}</div><div class="map-sale"><div class="sale-block"><figure><img class="  " alt="" src="${this.base_url + sale['main_image']}"></figure><div class="sale-actions"><div class="sale-time-remaining  specific-not-near "><i class="line-icon-clock"></i><span class="sale-schedule"><span class="time">${properties["sale_description"]}</span></span></div><div class="sale-price"></div><div class="clear-both"></div></div></div></div><div class="map-offers"><div class="offers-detail"><div class="offer-box-details"><div class="block-details-container"><div class="block-details block-details-double"><div class="details details-left"><h4>Без перелёта</h4><div class="best-price-details"><span class="offer-label"> От</span><div style="display: inline-flex;"><span class="offer-price details-price pound">₴${Math.trunc(without_flight) ?? 0}</span><span class="price-type">/чел<span> *</span></span></div><div class="clearfix"></div><div class="offer-insteadOf">вместо <del><strong>₴${Math.trunc(without_flight + without_flight * sale_up_to / 100)}</strong></del></div><div class="offer-duration">за <span>${without_flight_duration} ночей</span></div></div></div><div class="details details-right"><h4>С перелётом <i class="line-icon-plane"></i></h4><div class="best-price-details"><span class="offer-label"> От</span><div style="display: inline-flex;"><span class="offer-pricedetails-price pound">₴${Math.trunc(with_flight)}</span><span class="price-type">/чел<span> *</span></span></div><div class="clearfix"></div><div class="offer-insteadOf">вместо <del><strong>₴${Math.trunc(with_flight + with_flight * sale_up_to / 100)}</strong></del></div><div class="offer-duration">за <span>${with_flight_duration} ночей</span></div></div></div><div class="clear-both"></div></div></div><div class="block-durations-container"><i class="line-icon-calendar"></i>Доступная продолжительность от: <span style="font-weight: bold;">${durations}                                          ночь</span></div></div></div><div class="offers-subdetail">            <strong id="price-type-label"><strong class="offerblock__notice first">* при двухместном размещении</strong></strong></div>             <div class="clear-both"></div>             <a class="sale-button" href="/sale/${id}/${sale['slug']}" target="_blank"><span class="sale-button-title">Просмотреть</span><i class="icon-arrow-right-t1"></i></a></div></div></div>`)            .addTo(map);        });        map.on('mouseenter', 'clusters', () => {          map.getCanvas().style.cursor = 'pointer';        });        map.on('mouseleave', 'clusters', () => {          map.getCanvas().style.cursor = '';        });        map.on('click', 'clusters', (e) => {          const features = map.queryRenderedFeatures(e.point, {            layers: ['clusters']          });          const clusterId = features[0].properties.cluster_id;          map.getSource('my-geojson').getClusterExpansionZoom(            clusterId,            (err, zoom) => {              if (err) return;              map.easeTo({                center: features[0].geometry.coordinates,                zoom: zoom              });            }          );        });        map.on('mouseenter', 'clusters', () => {          map.getCanvas().style.cursor = 'pointer';        });        map.on('mouseleave', 'clusters', () => {          map.getCanvas().style.cursor = '';        });        map.on('mouseenter', 'marker-layer', () => {          map.getCanvas().style.cursor = 'pointer';        });        map.on('mouseleave', 'marker-layer', () => {          map.getCanvas().style.cursor = '';        });      })      let controls = map._controlPositions;      controls["bottom-left"].innerHTML = '';      controls["bottom-right"].innerHTML = '';    }  }}</script><style lang="scss">.marker {  cursor: pointer;  z-index: 9999;}.map-tooltip-clearfix {  width: auto;  height: auto;}.mapboxgl-popup-content {  width: 37rem;}.mapboxgl-popup-close-button {  transform: translate(-17px, 13px) scale(2.5);}.mapboxgl-map .mapboxgl-popup {  top: -1rem;}@media only screen and (max-width: 767px) {  #homepage-map .mapboxgl-popup-content {    width: 19rem;    padding-right: 0;  }  #searchBar .searchResult.pin.stacked {    width: 100%;  }}</style>